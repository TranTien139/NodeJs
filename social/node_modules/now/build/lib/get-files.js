"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0});var _promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_arrFlatten=require("arr-flatten"),_arrFlatten2=_interopRequireDefault(_arrFlatten),_arrayUnique=require("array-unique"),_arrayUnique2=_interopRequireDefault(_arrayUnique),_minimatch=require("minimatch"),_minimatch2=_interopRequireDefault(_minimatch),_ignored=require("./ignored"),_ignored2=_interopRequireDefault(_ignored),_path=require("path"),_fsPromise=require("fs-promise");exports["default"]=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t,n){var a,u,i,o,s,c,l=n.limit,f=void 0===l?null:l,p=n.debug,_=void 0===p?!1:p;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if(t){r.next=6;break}return a=(0,_path.resolve)(e,"package.json"),r.next=4,(0,_fsPromise.readFile)(a,"utf8");case 4:u=r.sent,t=JSON.parse(u);case 6:return i=(t.files||["."]).concat("package.json"),t.main&&(i=i.concat(t.main)),i=i.map(function(r){return asAbsolute(r,e)}),r.next=11,maybeRead((0,_path.resolve)(e,".npmignore"));case 11:if(o=r.sent,!o){r.next=16;break}r.t0="",r.next=19;break;case 16:return r.next=18,maybeRead((0,_path.resolve)(e,".gitignore"));case 18:r.t0=r.sent;case 19:return s=r.t0,c=(0,_arrayUnique2["default"])(_ignored2["default"].concat(s.split("\n").filter(invalidFilter)).concat(o.split("\n").filter(invalidFilter))).map(function(r){return(0,_path.resolve)(e,r)}),r.next=23,explode(i,c,{limit:f,debug:_});case 23:return r.t1=r.sent,r.abrupt("return",(0,_arrayUnique2["default"])(r.t1));case 25:case"end":return r.stop()}},r,this)}));return function(r,t,n){return e.apply(this,arguments)}}();var isIgnored=function(e,r){return r.some(function(r){var t=r+"/";return e.substr(0,t.length)===t?!0:(0,_minimatch2["default"])(e,r)})},invalidFilter=function(e){return!("#"===e[0]||!e.trim().length)},asAbsolute=function(e,r){return"/"===e[0]?e:(0,_path.resolve)(r,e)},explode=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t,n){var a,u,i=this,o=n.limit,s=n.debug;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return a=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,_promise2["default"].all(e.map(function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function t(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,u(e);case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}},t,i)})),r=i;return function(t){return e.apply(r,arguments)}}()));case 2:return r.abrupt("return",r.sent);case 3:case"end":return r.stop()}},t,i)})),r=i;return function(t){return e.apply(r,arguments)}}(),u=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function n(e){var r,u,c;return _regenerator2["default"].wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return r=e,u=void 0,n.prev=2,n.next=5,(0,_fsPromise.stat)(r);case 5:u=n.sent,n.next=14;break;case 8:return n.prev=8,n.t0=n["catch"](2),r=e+".js",n.next=13,(0,_fsPromise.stat)(r);case 13:u=n.sent;case 14:if(!isIgnored(e,t)){n.next=17;break}return s&&console.log('> [debug] Ignoring "'+e+'"'),n.abrupt("return",null);case 17:if(!u.isDirectory()){n.next=24;break}return n.next=20,(0,_fsPromise.readdir)(e);case 20:return c=n.sent,n.abrupt("return",a(c.map(function(r){return asAbsolute(r,e)})));case 24:if(!(null!=o&&u.size>o)){n.next=27;break}return console.error("> [31mWarning![39m Skipping file "+("over "+(0,_bytes2["default"])(o)+": "+r)),n.abrupt("return",null);case 27:return n.abrupt("return",r);case 28:case"end":return n.stop()}},n,i,[[2,8]])})),r=i;return function(t){return e.apply(r,arguments)}}(),r.next=4,a(e);case 4:return r.t0=r.sent,r.t1=function(e){return null!=e},r.abrupt("return",(0,_arrFlatten2["default"])(r.t0).filter(r.t1));case 7:case"end":return r.stop()}},r,this)}));return function(r,t,n){return e.apply(this,arguments)}}(),maybeRead=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,(0,_fsPromise.readFile)(e,"utf8");case 3:return r.abrupt("return",r.sent);case 6:return r.prev=6,r.t0=r["catch"](0),r.abrupt("return","");case 9:case"end":return r.stop()}},r,this,[[0,6]])}));return function(r){return e.apply(this,arguments)}}();