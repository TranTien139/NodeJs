"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function readEmail(){return new _promise2["default"](function(e,r){process.stdout.write("> Enter your email address: "),stdin.on("data",function(r){stdin.destroy(),e(r.toString().trim())})})}function sleep(e){return new _promise2["default"](function(r,t){setTimeout(r,e)})}Object.defineProperty(exports,"__esModule",{value:!0});var _assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_stringify=require("babel-runtime/core-js/json/stringify"),_stringify2=_interopRequireDefault(_stringify),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),getVerificationToken=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var t,n,a;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return t=(0,_stringify2["default"])({email:e}),r.next=3,(0,_nodeFetch2["default"])(URL,{method:"POST",headers:{"Content-Type":"application/json","Content-Length":Buffer.byteLength(t)},body:t});case 3:if(n=r.sent,200===n.status){r.next=6;break}throw new Error("Verification error");case 6:return r.next=8,n.json();case 8:return a=r.sent,r.abrupt("return",a.token);case 10:case"end":return r.stop()}},r,this)}));return function(r){return e.apply(this,arguments)}}(),verify=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e,t){var n,a,s;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return n={email:e,token:t},r.next=3,(0,_nodeFetch2["default"])(URL+"/verify?"+(0,_querystring.stringify)(n));case 3:return a=r.sent,r.next=6,a.json();case 6:return s=r.sent,r.abrupt("return",s.token);case 8:case"end":return r.stop()}},r,this)}));return function(r,t){return e.apply(this,arguments)}}(),register=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(){var e,t,n;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,readEmail();case 2:return e=r.sent,r.next=5,getVerificationToken(e);case 5:t=r.sent,console.log("> Please follow the link sent to "+_chalk2["default"].bold(e)+" to log in."),process.stdout.write("> Waiting for confirmation.."),n=void 0;case 9:return r.next=11,sleep(2500);case 11:return r.prev=11,r.next=14,verify(e,t);case 14:n=r.sent,r.next=19;break;case 17:r.prev=17,r.t0=r["catch"](11);case 19:process.stdout.write(".");case 20:if(!n){r.next=9;break}case 21:return process.stdout.write("\n"),r.abrupt("return",{email:e,token:n});case 23:case"end":return r.stop()}},r,this,[[11,17]])}));return function(){return e.apply(this,arguments)}}(),_os=require("os"),_path=require("path"),_path2=_interopRequireDefault(_path),_fsPromise=require("fs-promise"),_fsPromise2=_interopRequireDefault(_fsPromise),_nodeFetch=require("node-fetch"),_nodeFetch2=_interopRequireDefault(_nodeFetch),_querystring=require("querystring"),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),URL="http://api-registration.now.sh",stdin=process.openStdin();exports["default"]=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function e(){var r,t,n,a;return _regenerator2["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=_path2["default"].resolve((0,_os.homedir)(),".now.json"),e.next=3,register();case 3:return t=e.sent,n=null,e.prev=5,e.next=8,_fsPromise2["default"].readFile(r,"utf8");case 8:n=e.sent,n=JSON.parse(n),e.next=14;break;case 12:e.prev=12,e.t0=e["catch"](5);case 14:return a=(0,_assign2["default"])({},n,t),e.abrupt("return",_fsPromise2["default"].writeFile(r,(0,_stringify2["default"])(a)));case 16:case"end":return e.stop()}},e,this,[[5,12]])}));