#!/usr/bin/env node
"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{"default":e}}function handleError(e){error(403===e.status?"Authentication error. Run `now -L` or `now --login` to log-in again.":500===e.status?"Unexpected server error. Please retry.":"Unexpected error. Please try later. ("+e.message+")"),process.exit(1)}function error(e){console.error("> [31mError![39m "+e)}var _regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),sync=function(){var e=(0,_asyncToGenerator3["default"])(_regenerator2["default"].mark(function r(e){var o,t,n,a,c,l,s,i;return _regenerator2["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return o=!!_commander2["default"].debug,t=!_commander2["default"].noClipboard,n=Date.now(),console.log('> Deploying "'+path+'"'),a=new _lib2["default"](e,{debug:o}),r.prev=5,r.next=8,a.create(path,{forceNew:_commander2["default"].force});case 8:r.next=13;break;case 10:r.prev=10,r.t0=r["catch"](5),handleError(r.t0);case 13:if(c=a.url,l=(0,_ms2["default"])(new Date-n),!t){r.next=27;break}return r.prev=16,r.next=19,(0,_copy2["default"])(c);case 19:console.log("> "+_chalk2["default"].cyan("Ready!")+" "+_chalk2["default"].bold("https://"+c)+" (copied to clipboard) ["+l+"]"),r.next=25;break;case 22:r.prev=22,r.t1=r["catch"](16),console.log("> "+_chalk2["default"].cyan("Ready!")+" "+_chalk2["default"].bold("https://"+c)+" ["+l+"]");case 25:r.next=28;break;case 27:console.log("> "+c+" ["+l+"]");case 28:s=new Date,i=function(){var e=(0,_ms2["default"])(new Date-s);console.log("> Sync complete ("+(0,_bytes2["default"])(a.syncAmount)+") ["+e+"] "),a.close(),process.exit(0)},a.syncAmount?!function(){var e=new _progress2["default"]("> Upload [:bar] :percent :etas",{width:20,complete:"=",incomplete:"",total:a.syncAmount});a.upload(),a.on("upload",function(r){var t=r.name,n=r.data,a=Buffer.byteLength(n);o&&console.log("> [debug] Uploaded: "+t+" ("+(0,_bytes2["default"])(Buffer.byteLength(n))+")"),e.tick(a)}),a.on("complete",i),a.on("error",function(e){error("Upload failed"),handleError(e),process.exit(1)})}():(console.log("> Sync complete (cached)"),a.close(),process.exit(0));case 31:case"end":return r.stop()}},r,this,[[5,10],[16,22]])}));return function(r){return e.apply(this,arguments)}}(),_commander=require("commander"),_commander2=_interopRequireDefault(_commander),_progress=require("progress"),_progress2=_interopRequireDefault(_progress),_copy=require("../lib/copy"),_copy2=_interopRequireDefault(_copy),_path=require("path"),_login=require("../lib/login"),_login2=_interopRequireDefault(_login),_bytes=require("bytes"),_bytes2=_interopRequireDefault(_bytes),_chalk=require("chalk"),_chalk2=_interopRequireDefault(_chalk),_lib=require("../lib"),_lib2=_interopRequireDefault(_lib),_fs=require("fs"),_fs2=_interopRequireDefault(_fs),_ms=require("ms"),_ms2=_interopRequireDefault(_ms),_os=require("os"),_os2=_interopRequireDefault(_os);_commander2["default"].usage("[options]").option("-d, --debug","Debug mode [off]",!1).option("-f, --force","Force a new deployment even if nothing has changed",!1).option("-L, --login","Configure login").option("-C, --no-clipboard","Do not attempt to copy URL to clipboard").parse(process.argv);var path=_commander2["default"].args[_commander2["default"].args.length-1];path?"/"!==path[0]&&(path=(0,_path.resolve)(process.cwd(),path)):path=process.cwd();var config=void 0;try{config=_fs2["default"].readFileSync((0,_path.resolve)(_os2["default"].homedir(),".now.json"),"utf8"),config=JSON.parse(config)}catch(err){}config&&config.token&&!_commander2["default"].login?sync(config.token)["catch"](function(e){error("Unknown error: "+e.stack)}):(0,_login2["default"])().then(function(e){_commander2["default"].login?(console.log("> Logged in successfully. Token saved in ~/.now.json"),process.exit(0)):sync(e)["catch"](function(e){error("Unknown error: "+e.stack)})})["catch"](function(e){error("Authentication error â€“ "+e.message),process.exit(1)});